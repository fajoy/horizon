Content-Type: multipart/mixed; boundary="===============4865247342894093668=="
MIME-Version: 1.0

--===============4865247342894093668==
Content-Type: text/cloud-config; charset="us-ascii"
MIME-Version: 1.0
Content-Transfer-Encoding: 7bit
Content-Disposition: attachment; filename="a00_init"

#cloud-config
#ref https://cloudinit.readthedocs.org/en/latest/topics/examples.html
apt_sources:
 - source: "ppa:webupd8team/java"

apt_sources:
 - source: "ppa:hadoop-ubuntu/dev"

apt_mirror: http://ubuntu.cs.nctu.edu.tw/ubuntu/
repo_update: true

packages:
 - python-pip

{% if admin_pass %}
chpasswd:
  list: |
    root:{{admin_pass}}
  expire: False
{% endif %}
ssh_pwauth: True

ssh_keys:
  rsa_private: |
    -----BEGIN RSA PRIVATE KEY-----
    MIIEpAIBAAKCAQEAnHjpxO6bQL0V66xwT4Ib63RKUw9mSc1NLS67jjkARoUouslq
    B02WqGSncU3HRRLrN8T3VqMoy4LfqzFbuPKBIHEFNKEurj4+nyOy0sgDXzKDD7PV
    KTHBVVhoay19xWMcE5q6p0yid16j7HspcnfxULTrCTYB2pFmR2OEeKjgx39P3WGF
    Uv6YAh168e9McXZvOxg2ViGjU5Gegvhr1k1W/QXgMZJIfA88oZ/fxLO852uhp77b
    ZXykdjIU73I+BSHp2V993agvLMKdR9FY3fNeB/VpPgHouB/OxwwK82g/6/UemaCL
    QvwTDp+i6J+rVTIDJ4uhDOdhfbzZvCnOwDO5PwIDAQABAoIBAEE0KcZE4DF0GiRh
    cVPQli3iAe7m5esvQE/pv4Kewjyg1L4xnJt6e6Okfho7HSTto1NUIvXZe/CCkw5V
    vTEu7RxFvLOXz0oQ6iuKxsQLUUxkUjVC7TsDXttfwfOXu2d7y4Fn4wxAZRt1Nr4e
    /MCUtty455CpDtCz8nkhQVy+kxzOi/iAGE2fWz0GUf3fmzlhNaQcz4BVcdzQ2TqS
    1C+DMPeyXtA1Fc55BmdXSQv1hXI7geMXmt10Nb5yyaEzfiCrELJhZ+JyqetkHOah
    eIRYW0v33INaLQBt4LyKzs9oeoTVafgFPgE1PnJZKAQy2PGSZ0gMtDBwP8o+suWd
    iCpSM7ECgYEAyyCaEOHbv1jstyuPsbtxYmhIvrGP91F2MI7CL2K0xGWffJISkdu7
    WE1beK2Cu0Edn1shqnjcI4nwzcTjfp+3aCTy78gjEzSmd8a52yTCKHTiaotyri9T
    g8GcdUQdivO+AeDWatQyFOMtM3OZDVZu2s4MmyFUtefLw64GJSVSYKMCgYEAxTNz
    lrvxU1ekX1KlyRVnbbMCk8W+XVcj3ZVPdqQojPClMG+2QBaxZbQlWlSahi30SAQy
    RffT+T1Qq0xBZp/N0bmnWGkl+tw2imD0Z0Pvk69aiBtaTPBe8gpohdwRaiKav66n
    iXQG1RjoxHvquoZ24kj/ku4GV2wvnikhyjCdYrUCgYEAxFYk1MCa2N8pHvt6Dv7w
    33+RINEcKJ+Sr+itBYRQ2ayodY3zaQyMjxNmoMSFol2UNl2tssrTbX59RUdT5SaX
    7pAYSXCXho7TgN6S8qEbEmO4Heff10FjZe0UP7yxGYfzVnluhx/HsKzNGfhYLa4n
    xFJ5mNCkwpbkO6XPxsPGViUCgYEApQRGEHebHMu1H5MwadFAaHqoiHGrt73opE6C
    XVxHFpF1GdARaRXUQq/5pdowKGIiDXV9gDE/L0yQyZcZD0BgYcSCdagfgQlvlmJF
    gnhF7YaKMmT5LnLicJYnGwSpifAFIKuNRKdT5FRgy7KKHKXSq868Fv6ZTeSZADeZ
    L/F4chUCgYArg8lk9BUGQyOnpQdAHD3gdP6HgyCFiuSjYQJ4PZwGB5Y2YkLB+3Es
    r3NTKLxzL9gFcVBLzOJdN5QynJ4yqvgkF8SeJ/+MZ5JYogKroj8TR0UIV7kN3cvy
    xvRLLrcCuJCxfsG/fdFQFJPe2thIB0LkCION0Aen5HLy3FR1azo9uQ==
    -----END RSA PRIVATE KEY-----
  rsa_public: ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCceOnE7ptAvRXrrHBPghvrdEpTD2ZJzU0tLruOOQBGhSi6yWoHTZaoZKdxTcdFEus3xPdWoyjLgt+rMVu48oEgcQU0oS6uPj6fI7LSyANfMoMPs9UpMcFVWGhrLX3FYxwTmrqnTKJ3XqPseylyd/FQtOsJNgHakWZHY4R4qODHf0/dYYVS/pgCHXrx70xxdm87GDZWIaNTkZ6C+GvWTVb9BeAxkkh8Dzyhn9/Es7zna6GnvttlfKR2MhTvcj4FIenZX33dqC8swp1H0Vjd814H9Wk+Aei4H87HDArzaD/r9R6ZoItC/BMOn6Lon6tVMgMni6EM52F9vNm8Kc7AM7k/ root@localhost

  dsa_private: |
    -----BEGIN DSA PRIVATE KEY-----
    MIIBugIBAAKBgQDcCgpQ2WNPYTngXJW2Ym01HGu45ANS5kvjIcPy3mdJu1609baZ
    i3S+iG34kDkkKwbCQ5b/S9R6t5Y0siWtlspU9C321yGUaA8cFTpnlCKyt1keXSZ8
    VgpG7/V8xwmU3p1cT4IIHTxWH2BXM3VNgnd3Zfc5c3lYpSbA1Uwd7DuL7wIVAPm0
    9Brt/t4eyRa3CMfT6XYEZ4WfAoGAUBaRSYqe4aautlD4maIYsFWJPsK43Nbng0Rf
    q0CZoX4tqnOKzF9WFuX+hINmZklYQEbVe587DvN7WAOAmLRM3SWPwRFj1OskzDa8
    C+dHy59OBfGeRCDALK/cNgAecPS9rIEMoCzW8XQ/kJp0tBHI7B1LgVKp1XsgVurN
    l+9gjycCgYB+XMK4SQTCA1ggVaOBWcf8+hkQKUnG+2yljkgimmoOuyVO0fwLE2Dl
    4Vaun9/5LfKH8kyq2+CtSOgqIocaObcpD1Hr4U8GoL/7khcvXBZuL8kn+9LgzzP7
    LsxjVGaY9A/6Y3rpdfYTf8HCEZaiegOua8CWBfZpdTaBDzMCxnKNuQIULGqaQbGp
    oaSzt58TJ27nZiRE9cM=
    -----END DSA PRIVATE KEY-----

  dsa_public: ssh-dss AAAAB3NzaC1kc3MAAACBANwKClDZY09hOeBclbZibTUca7jkA1LmS+Mhw/LeZ0m7XrT1tpmLdL6IbfiQOSQrBsJDlv9L1Hq3ljSyJa2WylT0LfbXIZRoDxwVOmeUIrK3WR5dJnxWCkbv9XzHCZTenVxPgggdPFYfYFczdU2Cd3dl9zlzeVilJsDVTB3sO4vvAAAAFQD5tPQa7f7eHskWtwjH0+l2BGeFnwAAAIBQFpFJip7hpq62UPiZohiwVYk+wrjc1ueDRF+rQJmhfi2qc4rMX1YW5f6Eg2ZmSVhARtV7nzsO83tYA4CYtEzdJY/BEWPU6yTMNrwL50fLn04F8Z5EIMAsr9w2AB5w9L2sgQygLNbxdD+QmnS0EcjsHUuBUqnVeyBW6s2X72CPJwAAAIB+XMK4SQTCA1ggVaOBWcf8+hkQKUnG+2yljkgimmoOuyVO0fwLE2Dl4Vaun9/5LfKH8kyq2+CtSOgqIocaObcpD1Hr4U8GoL/7khcvXBZuL8kn+9LgzzP7LsxjVGaY9A/6Y3rpdfYTf8HCEZaiegOua8CWBfZpdTaBDzMCxnKNuQ== root@localhost

ssh_authorized_keys:
  - ssh-dss AAAAB3NzaC1kc3MAAACBANYli/FdFxEPzhQBQn7N469xt7C85KRF4uTTv9QkrVbV7W0b6dKl/wzwL9QDkDfSah04J1rzKTaDz+wiKezUhj7fRGSWjAA77IW4m5onPPH0EXBDzCFCaEfAIlvGlPw6dEtPL4RjJ/2CwUI7xsZCjXi0SNm2XIJf2uB4fY9c76u3AAAAFQDfHbHUh04LWWLENs4F+dHe9pCSNQAAAIEAvY9RX7JpF5ARzvRM2jakDZB27H7iwhukGSXnRk7cWAKKlMD1F1eHUgWk7ueqFjKu8Wdr5Uzc0upx1KPT/4hIHFPteEphlprOQxgPiPr9QYFMN/FF8zt7I5JR/TkjOkwypsDy2Xi2A7O6Br5U+Emz5Hsrv3X4GJS/qNzlLVirhhIAAACAYelWvrGU1gtcioTnoX+aldHeNtCooA7JPtvPS1D8wNi+o4H+MJqkKuUiC6kh/fwgHE+fhc8Kj/7b+Uttb92A8jRnhgv3BLoQKooduS4IEzJ/pqvKhVrEYGTvHACQgSY7F2VAxGigcs2rpZ/glSdJwlIahO9OLTzZJEcJVPVgbTc= root@localhost

--===============4865247342894093668==
Content-Type: text/x-shellscript; charset="us-ascii"
MIME-Version: 1.0
Content-Transfer-Encoding: 7bit
Content-Disposition: attachment; filename="a01_make_boto.py"

#!/usr/bin/env python
aws_access_key_id = '{{ ec2_access_key }}'
aws_secret_access_key = '{{ ec2_secret_key }}'
host = 's3.nctu.edu.tw'
calling_format = 'boto.s3.connection.OrdinaryCallingFormat'
is_secure = 'False'

import ConfigParser,os
def set_boto():
    fn="/root/.boto"
    if os.path.exists(fn):
        return
    conf = ConfigParser.SafeConfigParser()
    conf.add_section('Credentials')
    conf.add_section('s3')
    conf.add_section('Boto')
    conf.set('Credentials','aws_access_key_id', aws_access_key_id)
    conf.set('Credentials','aws_secret_access_key', aws_secret_access_key)
    conf.set('s3','host', host)
    conf.set('s3','calling_format', calling_format)
    conf.set('Boto','is_secure', is_secure)
    fd = open(fn, 'wb')
    conf.write(fd)
    fd.close()
set_boto()
--===============4865247342894093668==
Content-Type: text/x-shellscript; charset="us-ascii"
MIME-Version: 1.0
Content-Transfer-Encoding: 7bit
Content-Disposition: attachment; filename="a01_rc.sh"

#!/bin/bash
#==output to console==
exec 1>/dev/console
exec 2>/dev/console
echo "====BEGIN rc.sh======="
sudo ifconfig eth0 mtu 1454
cp /var/lib/cloud/data/previous-instance-id /etc/hostname
hostname -F /etc/hostname
echo `awk 'BEGIN{n=-1} /^S.local-ipv4.$/{ n=NR+2 } (NR==n){printf $0} '  < /var/lib/cloud/instance/obj.pkl   |sed "s/[S']//g"`   `cat /etc/hostname` |tee /etc/hosts
echo -n "{{ tenant_id }}" |tee /root/tenant_id |xargs echo tenant_id 
echo -n "{{ hadoop_group_id }}" |tee /root/hadoop_group_id |xargs echo hadoop_group_id
echo -n "{{ hadoop_master_id }}" |tee /root/hadoop_master_id |xargs echo hadoop_master_id
echo "====Install boto======="
pip install boto --upgrade
echo "====make script======="
base64 -d <<< H4sICKIN0VEAA3J1bl9oYWRvb3BfZGVhbW9uLnNoAI1QTUvDQBC951dMW/C2jnjwIgoFBSlYL8WLSDrpbppNk52wOxYRf7zbhpgoxHp98z7mvdkEM+swo1Ak5r1hL7CYP8/Th6fH+xt8Cx4rm2G5r7GkPakrxZ42lUlsDi+gPmC63pBAQZq5SWsKYnxq9XoKr3ANUhiXzFoUgpCXVjcBZQClbrAVKs8sqPOAjmrTS4/5h/daGhyujrUBlbOvSZLcJoNPyibA59abBpaRuIzE4R+jZpe3eMzvgPOKt3A26r3gbBU32Bn/l3vJmbSsb/8e6hO6cYzTcX4rcDGae0dCpzrpyPnRqQNOdFpR2P2jlETa71YDbBDyBZJsEWdXAgAA |gzip -d >/root/run_hadoop_deamon.sh
chmod +x /root/run_hadoop_deamon.sh
base64 -d <<< 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 |gzip -d > /root/update_status.py
chmod +x /root/update_status.py
base64 -d <<< H4sICDb70FEAA2Nyb250YWIArVCxasMwEJ2tr3hgCI3BEQlNDIEMHQoZMhTavSiWwKaWZKQTriEfX9lOnSyFDpEQp3v37t3jUnBFJS+dNSTOe/jek9J5V0uFK8jej6+n04Gfa8N9xd5ePo4HHrzjjS1Fw33E93f5mE7gXLlx4oexFBoVpNXQ1sTYIXjlktJqLYxk6wJZkiHexFlLiKeU4Fgs4ILJW+HII8+daq2jm/9VZYNrerbZYnfXnpDyhPwbsxMujBgacLng6X/SUtRNjyV7Lq7axeO0O6W+RvHtJoqvH2s8LpiqUT1lWVzk9LIx/i53njMAPLRSkPr0JCj4VdsPI6ZhIz9mf/CW7AcypddHTQIAAA== |gzip -d > /etc/crontab
echo "=====END rc.sh========"
